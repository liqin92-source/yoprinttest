<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CSV Upload Dashboard</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css"
      referrerpolicy="no-referrer"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #f5f5f5;
        margin: 0;
        padding: 0;
      }

      header {
        background-color: #2f3a56;
        color: #fff;
        padding: 16px 24px;
      }

      header h1 {
        margin: 0;
        font-size: 1.4rem;
      }

      main {
        padding: 24px;
        max-width: 960px;
        margin: 0 auto;
      }

      .upload-card {
        background-color: #fff;
        border-radius: 8px;
        padding: 24px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 24px;
      }

      .drop-zone {
        border: 2px dashed #bbb;
        border-radius: 8px;
        padding: 30px;
        text-align: center;
        color: #555;
        transition: border-color 0.3s ease;
      }

      .drop-zone.dragover {
        border-color: #2f3a56;
      }

      .actions {
        margin-top: 16px;
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }

      button {
        background-color: #2f3a56;
        color: #fff;
        border: none;
        padding: 10px 18px;
        border-radius: 6px;
        cursor: pointer;
      }

      button:disabled {
        background-color: #9aa4b7;
        cursor: not-allowed;
      }

      .status {
        font-size: 0.9rem;
        color: #2f3a56;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        background-color: #fff;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }

      th,
      td {
        padding: 14px 16px;
        border-bottom: 1px solid #e5e7eb;
        text-align: left;
        font-size: 0.95rem;
      }

      th {
        background-color: #f0f2f7;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85rem;
        color: #2f3a56;
      }

      tr:last-child td {
        border-bottom: none;
      }

      .badge {
        border-radius: 999px;
        padding: 4px 10px;
        font-size: 0.8rem;
        text-transform: capitalize;
        display: inline-block;
      }

      .badge.pending {
        background-color: #fef3c7;
        color: #92400e;
      }

      .badge.processing {
        background-color: #dbeafe;
        color: #1d4ed8;
      }

      .badge.completed {
        background-color: #dcfce7;
        color: #166534;
      }

      .badge.failed {
        background-color: #fee2e2;
        color: #991b1b;
      }

      .error {
        color: #b91c1c;
        font-size: 0.9rem;
      }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/plugin/relativeTime.min.js" referrerpolicy="no-referrer"></script>
    <script>
      dayjs.extend(dayjs_plugin_relativeTime);
    </script>
  </head>
  <body>
    <header>
      <h1>CSV Uploads</h1>
    </header>
    <main>
      <section class="upload-card">
        <div
          id="dropZone"
          class="drop-zone"
        >
          <p><strong>Select file</strong> or drag and drop your CSV</p>
          <input type="file" id="fileInput" accept=".csv" style="display: none" />
        </div>
        <div class="actions">
          <span class="status" id="statusMessage"></span>
          <button id="chooseFileButton" type="button">Choose File</button>
          <button id="uploadButton" type="button" disabled>Upload File</button>
        </div>
        <p class="error" id="errorMessage"></p>
      </section>

      <section>
        <table>
          <thead>
            <tr>
              <th>Time</th>
              <th>File Name</th>
              <th>Status</th>
              <th>Progress</th>
            </tr>
          </thead>
          <tbody id="uploadsTableBody">
            <tr>
              <td colspan="4" style="text-align: center; padding: 24px;">No uploads yet.</td>
            </tr>
          </tbody>
        </table>
      </section>
    </main>

    <script>
      const fileInput = document.getElementById('fileInput');
      const uploadButton = document.getElementById('uploadButton');
      const chooseFileButton = document.getElementById('chooseFileButton');
      const statusMessage = document.getElementById('statusMessage');
      const errorMessage = document.getElementById('errorMessage');
      const uploadsTableBody = document.getElementById('uploadsTableBody');
      const dropZone = document.getElementById('dropZone');

      let selectedFile = null;

      const formatDate = (dateString) => {
        if (!dateString) {
          return '-';
        }
        const date = dayjs(dateString);
        return `${date.format('YYYY-MM-DD HH:mm')} (${date.fromNow()})`;
      };

      const renderUploads = (uploads) => {
        uploadsTableBody.innerHTML = '';

        if (!uploads.length) {
          uploadsTableBody.innerHTML =
            '<tr><td colspan="4" style="text-align: center; padding: 24px;">No uploads yet.</td></tr>';
          return;
        }

        uploads.forEach((upload) => {
          const row = document.createElement('tr');
          const progress = upload.total_rows
            ? `${upload.processed_rows || 0} / ${upload.total_rows}`
            : '-';
          row.innerHTML = `
            <td>${formatDate(upload.created_at)}</td>
            <td>${upload.original_filename}</td>
            <td><span class="badge ${upload.status}">${upload.status}</span></td>
            <td>${progress}</td>
          `;
          uploadsTableBody.appendChild(row);
        });
      };

      const fetchUploads = async () => {
        try {
          const response = await fetch('/api/uploads');
          if (!response.ok) {
            throw new Error('Failed to fetch uploads');
          }
          const data = await response.json();
          renderUploads(data.uploads || []);
        } catch (error) {
          console.error(error);
        }
      };

      const resetSelection = () => {
        fileInput.value = '';
        selectedFile = null;
        uploadButton.disabled = true;
        statusMessage.textContent = '';
      };

      chooseFileButton.addEventListener('click', () => fileInput.click());

      uploadButton.addEventListener('click', async () => {
        if (!selectedFile) {
          return;
        }
        errorMessage.textContent = '';
        statusMessage.textContent = 'Uploading...';
        uploadButton.disabled = true;

        const formData = new FormData();
        formData.append('file', selectedFile);

        try {
          const response = await fetch('/api/upload', {
            method: 'POST',
            body: formData,
          });

          if (!response.ok) {
            const data = await response.json();
            throw new Error(data.error || 'Upload failed');
          }

          statusMessage.textContent = 'Upload scheduled for processing.';
          resetSelection();
          fetchUploads();
        } catch (error) {
          errorMessage.textContent = error.message;
          statusMessage.textContent = '';
          uploadButton.disabled = false;
        }
      });

      fileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) {
          resetSelection();
          return;
        }

        if (!file.name.toLowerCase().endsWith('.csv')) {
          errorMessage.textContent = 'Please select a CSV file.';
          resetSelection();
          return;
        }

        selectedFile = file;
        uploadButton.disabled = false;
        statusMessage.textContent = `Ready to upload: ${file.name}`;
        errorMessage.textContent = '';
      });

      dropZone.addEventListener('click', () => fileInput.click());

      dropZone.addEventListener('dragover', (event) => {
        event.preventDefault();
        dropZone.classList.add('dragover');
      });

      dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));

      dropZone.addEventListener('drop', (event) => {
        event.preventDefault();
        dropZone.classList.remove('dragover');

        const file = event.dataTransfer.files[0];
        if (!file) {
          return;
        }

        fileInput.files = event.dataTransfer.files;
        fileInput.dispatchEvent(new Event('change'));
      });

      fetchUploads();
      setInterval(fetchUploads, 5000);
    </script>
  </body>
</html>

